- name: ohpc2
  hosts: ohpc2
  become: yes
  gather_facts: True
  vars:
    jenkins_name: lenovo
  tasks:
  - name: install packages
    package:
      state: present
      name:
      - java-17-openjdk-headless
      - git
      - ipmitool
      - netcat
      - rsync
      - ansible
      - vim-enhanced
      - bash-completion
      - wget
      - epel-release

  - name: install jenkins systemd unit files
    copy:
      src: "{{item}}"
      dest: /etc/systemd/system/{{item}}
      owner: root
      group: root
      mode: 0644
    register: jenkins_agent_service_1
    with_items:
    - swarm-prepare.service
    - jenkins-prepare.service

  - name: install jenkins systemd unit files
    template:
      src: jenkins-agent.service
      dest: /etc/systemd/system/jenkins-agent.service
      owner: root
      group: root
      mode: 0644
    register: jenkins_agent_service_2

  - name: systemd daemon-reload
    ansible.builtin.systemd:
      daemon_reload: true
    when: jenkins_agent_service_1.changed or jenkins_agent_service_2.changed

  - name: enable jenkins agent service
    service: name=jenkins-agent enabled=yes state=started

  - name: enable swarm prepare service
    service: name=swarm-prepare enabled=yes state=started
